#!/bin/bash
#
# mcp-install — unified installer for MCP servers
#
# Usage:
#   mcp-install                  # list available servers
#   mcp-install <server>         # install a server (prompts for config)
#   mcp-install <server> [opts]  # install with pre-supplied config
#

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
SERVERS_DIR="$SCRIPT_DIR/servers"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

info()  { echo -e "${GREEN}==>${NC} $1"; }
warn()  { echo -e "${YELLOW}==>${NC} $1"; }
fail()  { echo -e "${RED}==>${NC} $1"; exit 1; }
header() { echo -e "\n${BOLD}${CYAN}$1${NC}"; }

# ---------------------------------------------------------------------------
# prompt_value VAR_NAME "prompt text" ["default"]
#   Reads a value from the user. If $VAR_NAME is already set (via env or CLI
#   flag), it is kept. An empty default means the field is required.
# ---------------------------------------------------------------------------
prompt_value() {
    local var_name="$1" prompt_text="$2" default="$3"
    local current_val="${!var_name}"

    if [ -n "$current_val" ]; then
        return  # already set via flag / env
    fi

    if [ -n "$default" ]; then
        read -rp "$(echo -e "${GREEN}?${NC}") $prompt_text [${default}]: " input
        eval "$var_name=\"${input:-$default}\""
    else
        while true; do
            read -rp "$(echo -e "${GREEN}?${NC}") $prompt_text: " input
            if [ -n "$input" ]; then
                eval "$var_name=\"$input\""
                return
            fi
            echo -e "  ${RED}This field is required.${NC}"
        done
    fi
}

# ---------------------------------------------------------------------------
# prompt_optional VAR_NAME "prompt text"
#   Reads an optional value. Empty input is accepted.
# ---------------------------------------------------------------------------
prompt_optional() {
    local var_name="$1" prompt_text="$2"
    local current_val="${!var_name}"

    if [ -n "$current_val" ]; then
        return
    fi

    read -rp "$(echo -e "${DIM}?${NC}") $prompt_text ${DIM}(optional, press Enter to skip)${NC}: " input
    if [ -n "$input" ]; then
        eval "$var_name=\"$input\""
    fi
}

# ---------------------------------------------------------------------------
# show_usage — print server catalog and exit
# ---------------------------------------------------------------------------
show_usage() {
    echo -e "${BOLD}mcp-install${NC} — unified installer for MCP servers"
    echo
    echo -e "${BOLD}Usage:${NC}"
    echo "  mcp-install <server> [options]"
    echo
    echo -e "${BOLD}Available servers:${NC}"
    echo
    echo -e "  ${CYAN}azure-devops-mcp${NC}   Query Azure DevOps work items, repos, pipelines"
    echo -e "    Prerequisites:   Node.js 18+"
    echo -e "    Options:         ${GREEN}--org${NC} <name>        Azure DevOps organization ${DIM}(prompted if omitted)${NC}"
    echo
    echo -e "  ${CYAN}gitignore-mcp${NC}      Manage .gitignore files using templates"
    echo -e "    Prerequisites:   Go 1.23+ or curl"
    echo -e "    Options:         ${DIM}(none)${NC}"
    echo
    echo -e "  ${CYAN}panorama-mcp${NC}       Palo Alto Panorama management via browser SSO"
    echo -e "    Prerequisites:   Python 3.10+, Microsoft Edge"
    echo -e "    Options:         ${GREEN}--urls${NC} <urls>       Comma-separated Panorama URLs ${DIM}(prompted if omitted)${NC}"
    echo -e "                     ${GREEN}--sso-account${NC} <email>  SSO account for auto-fill ${DIM}(optional)${NC}"
    echo
    echo -e "  ${CYAN}servicenow-mcp${NC}     ServiceNow CMDB, incidents, changes via SSO"
    echo -e "    Prerequisites:   Python 3.9+"
    echo -e "    Options:         ${GREEN}--instance${NC} <host>   ServiceNow instance ${DIM}(prompted if omitted)${NC}"
    echo
    echo -e "${BOLD}Examples:${NC}"
    echo "  mcp-install azure-devops-mcp --org contoso"
    echo "  mcp-install gitignore-mcp"
    echo "  mcp-install panorama-mcp --urls https://panoramav2.example.com"
    echo "  mcp-install servicenow-mcp --instance mycompany.service-now.com"
    exit 0
}

# ---------------------------------------------------------------------------
# print_env_summary — show env vars to export
# ---------------------------------------------------------------------------
print_env_summary() {
    local server="$1"
    shift
    # remaining args are "KEY=VALUE" pairs

    if [ $# -eq 0 ]; then
        return
    fi

    echo
    header "Configuration"
    echo -e "Add these to your shell profile or .env file:"
    echo
    for pair in "$@"; do
        echo "  export $pair"
    done
    echo
}

# ---------------------------------------------------------------------------
# print_vscode_snippet — show VS Code mcp.json entry
# ---------------------------------------------------------------------------
print_vscode_snippet() {
    local server="$1"
    echo
    header "VS Code setup"
    echo -e "Merge this into ${BOLD}.vscode/mcp.json${NC} (see servers/${server}/install.md for details):"
    echo
}

# ============================= SERVER HANDLERS =============================

install_azure_devops_mcp() {
    local ADO_ORG=""

    # Parse flags
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --org) ADO_ORG="$2"; shift 2 ;;
            *) warn "Unknown option: $1"; shift ;;
        esac
    done

    header "Installing azure-devops-mcp"

    # Prompt for required config
    prompt_value ADO_ORG "Azure DevOps organization name (e.g. contoso)"

    # Run inner installer
    info "Running installer..."
    bash "$SERVERS_DIR/azure-devops-mcp/install.sh"

    # Post-install summary
    print_env_summary "azure-devops-mcp"

    echo
    header "Usage"
    echo "  npx -y @azure-devops/mcp ${ADO_ORG}"
    echo

    print_vscode_snippet "azure-devops-mcp"
    cat <<SNIPPET
{
    "servers": {
        "ado": {
            "type": "stdio",
            "command": "npx",
            "args": ["-y", "@azure-devops/mcp", "${ADO_ORG}"]
        }
    }
}
SNIPPET
    echo
}

install_gitignore_mcp() {
    # No config needed — parse and discard unknown flags
    while [[ $# -gt 0 ]]; do
        warn "Unknown option: $1"; shift
    done

    header "Installing gitignore-mcp"

    # Run inner installer
    info "Running installer..."
    bash "$SERVERS_DIR/gitignore-mcp/install.sh"

    print_vscode_snippet "gitignore-mcp"
    cat <<'SNIPPET'
{
    "servers": {
        "gitignore": {
            "type": "stdio",
            "command": "gitignore",
            "args": ["serve"]
        }
    }
}
SNIPPET
    echo
}

install_panorama_mcp() {
    local PANORAMA_URLS="" PANORAMA_SSO_ACCOUNT=""

    # Parse flags
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --urls)        PANORAMA_URLS="$2"; shift 2 ;;
            --sso-account) PANORAMA_SSO_ACCOUNT="$2"; shift 2 ;;
            *) warn "Unknown option: $1"; shift ;;
        esac
    done

    header "Installing panorama-mcp"

    # Prompt for config
    prompt_value    PANORAMA_URLS        "Panorama URL(s), comma-separated (e.g. https://panoramav2.example.com)"
    prompt_optional PANORAMA_SSO_ACCOUNT "SSO account for auto-fill (e.g. user@company.com)"

    # Run inner installer
    info "Running installer..."
    bash "$SERVERS_DIR/panorama-mcp/install.sh"

    # Post-install summary
    local env_pairs=("PANORAMA_URLS=\"${PANORAMA_URLS}\"")
    if [ -n "$PANORAMA_SSO_ACCOUNT" ]; then
        env_pairs+=("PANORAMA_SSO_ACCOUNT=\"${PANORAMA_SSO_ACCOUNT}\"")
    fi
    print_env_summary "panorama-mcp" "${env_pairs[@]}"

    # VS Code snippet
    local VENV_PYTHON="$SERVERS_DIR/panorama-mcp/.venv/bin/python"
    print_vscode_snippet "panorama-mcp"
    local sso_line=""
    if [ -n "$PANORAMA_SSO_ACCOUNT" ]; then
        sso_line="
                \"PANORAMA_SSO_ACCOUNT\": \"${PANORAMA_SSO_ACCOUNT}\","
    fi
    cat <<SNIPPET
{
    "servers": {
        "panorama": {
            "type": "stdio",
            "command": "${VENV_PYTHON}",
            "args": ["-m", "panorama_mcp", "serve", "--no-preauth"],
            "env": {
                "PANORAMA_URLS": "${PANORAMA_URLS}",${sso_line}
                "PANORAMA_HEADLESS": "false"
            }
        }
    }
}
SNIPPET
    echo
}

install_servicenow_mcp() {
    local SERVICENOW_INSTANCE=""

    # Parse flags
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --instance) SERVICENOW_INSTANCE="$2"; shift 2 ;;
            *) warn "Unknown option: $1"; shift ;;
        esac
    done

    header "Installing servicenow-mcp"

    # Prompt for required config
    prompt_value SERVICENOW_INSTANCE "ServiceNow instance hostname (e.g. mycompany.service-now.com)"

    # Run inner installer
    info "Running installer..."
    bash "$SERVERS_DIR/servicenow-mcp/install.sh"

    # Post-install summary
    print_env_summary "servicenow-mcp" "SERVICENOW_INSTANCE=\"${SERVICENOW_INSTANCE}\""

    # VS Code snippet
    local VENV_CMD="$SERVERS_DIR/servicenow-mcp/.venv/bin/servicenow-mcp"
    print_vscode_snippet "servicenow-mcp"
    cat <<SNIPPET
{
    "servers": {
        "servicenow": {
            "type": "stdio",
            "command": "${VENV_CMD}",
            "args": ["serve", "--no-preauth"],
            "env": {
                "SERVICENOW_INSTANCE": "${SERVICENOW_INSTANCE}"
            }
        }
    }
}
SNIPPET
    echo
}

# ===========================================================================
# Main
# ===========================================================================

if [ $# -eq 0 ]; then
    show_usage
fi

SERVER="$1"
shift

case "$SERVER" in
    azure-devops-mcp) install_azure_devops_mcp "$@" ;;
    gitignore-mcp)    install_gitignore_mcp "$@" ;;
    panorama-mcp)     install_panorama_mcp "$@" ;;
    servicenow-mcp)   install_servicenow_mcp "$@" ;;
    -h|--help)        show_usage ;;
    *)
        fail "Unknown server: ${SERVER}
Run 'mcp-install' with no arguments to see available servers."
        ;;
esac
